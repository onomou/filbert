<div id="assignments-sidebar" class="sidebar secondary-sidebar">
  <div class="assignments-sticky">
    <h3 id="toggle-assignments">Assignments</h3>
    <ul>
      <li class="sidebar-item" id="assignments-refresh">
        <a href="/courses/{{ active_course.id }}/assignments/refresh">Refresh ↺</a>
      </li>
      <li class="sidebar-item">
        <a href="/courses/{{ active_course.id }}/assignments/list">List ≡</a>
      </li>
      <li class="sidebar-item{{ ' active' if not assignment or not assignment['id'] }}">
        <a href="/courses/{{ active_course.id }}/assignments/new" class="sidebar-new-assignment">New Assignment</a>
      </li>
    </ul>
  </div>

  <ul>
    {% for for_assignment in assignments %}
    <li class="sidebar-item{{ ' active' if assignment and assignment['id'] == for_assignment.id }}{{ ' published' if for_assignment and for_assignment['published'] }}">
      <a href="{{ url_for('assignments_page', course_id=active_course.id, assignment_id=for_assignment.id) }}"
        class="sidebar-assignment-link" id="sidebar-assignment-{{ for_assignment.id }}"
        data-dataurl="{{ url_for( 'push_page', course_id=active_course.id, assignment_id=for_assignment.id) }}"
        data-parseurl="{{ url_for('render_topbar',course_id=active_course.id,url=for_assignment.html_url) }}">
        <div class="secondary-sidebar-name" data-shortname="{{ for_assignment.name[:10] }}..."
          data-longname="{{ for_assignment.name }}"
          title="{{ for_assignment.name }}&#13;Due: {{ for_assignment.due_at if for_assignment.short_date else 'Not set' }}">
          {{ for_assignment.name }}
        </div>
        <div class="secondary-sidebar-details">
          <span class="date">
            {{ for_assignment.short_date }}
          </span>
          <span class="points">
            {{ for_assignment.points_possible }}
          </span>
        </div>
      </a>
    </li>
    {% endfor %}
  </ul>
</div>

<script>
  // handle click on assignments sidebar items
  $('a.sidebar-assignment-link').on('click', function(event) {
    if( event.ctrlKey || event.shiftKey || !document.getElementById('assignment-details') ) return true;
    var data_url = $(this).data('dataurl');
    var history_url = $(this).attr('href');
    window.history.pushState(null,"",history_url);
    fetch(data_url)
    .then(response => {return response.text()})
    .then(data => {
      if (data) {
        document.getElementById('assignment-details').innerHTML = data
      } else {
        document.getElementById('assignment-details').innerHTML = ""
      }
    })
    .then(() => {
      // reinit interactive elements
      initTinyMCE();
      initDatePicker();
      initChangeHandler();

      // change which item is active
      $(".secondary-sidebar .sidebar-item").removeClass('active');
      $(this).parent().addClass('active');

      var parse_url = $(this).data('parseurl');
      console.log(parse_url)
      fetch(parse_url)
      .then(response => {return response.text()})
      .then(data => {$("#topbar").html(data)})
    });
    // event.preventDefault();
    return false;
  })
</script>